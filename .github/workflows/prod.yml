name: Package and E2E

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build scheduler
      run: |
        export PYTHONPATH=$(pwd)
        export VERSION=$(python3 -c 'import scheduler; print(scheduler.__version__)')
        docker build -t docker.pkg.github.com/hadar-simulator/community-server/scheduler:$VERSION -f scheduler/Dockerfile .
        echo "::set-env name=SCHEDULER_VERSION::$VERSION"
    - name: Build worker
      run: |
        echo $SCHEDULER_VERSION
        source .env # set HADAR_VERSION variable
        docker build -t docker.pkg.github.com/hadar-simulator/community-server/worker:$SCHEDULER_VERSION-$HADAR_VERSION --build-arg HADAR_VERSION=$HADAR_VERSION -f worker/Dockerfile .
    - name: E2E
      run: |
        docker images
        docker login docker.pkg.github.com -u $GITHUB_ACTOR -p $TOKEN
      env:
        TOKEN: ${{ secrets.GITHUB_TOKEN }}
